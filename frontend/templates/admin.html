{% extends "base.html" %}

{% block title %}Admin Panel - Twarga Cloud MVP{% endblock %}

{% block content %}
<div x-data="adminPanel()" x-init="init()" class="px-4 py-6 sm:px-0">
    <!-- Admin Panel Content -->
    <div class="space-y-6">
        <h1 class="text-3xl font-bold text-gray-900">Admin Panel</h1>
        
        <!-- System Overview Statistics -->
        <div class="grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-4">
            <!-- Total Users -->
            <div class="bg-white overflow-hidden shadow rounded-lg">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="w-12 h-12 bg-blue-500 rounded-md flex items-center justify-center text-2xl">
                                üë•
                            </div>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 truncate">
                                    Total Users
                                </dt>
                                <dd class="text-2xl font-bold text-gray-900" x-text="stats.users?.total || 0"></dd>
                                <dd class="text-xs text-gray-500" x-text="`${stats.users?.active || 0} active`"></dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Active VMs -->
            <div class="bg-white overflow-hidden shadow rounded-lg">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="w-12 h-12 bg-green-500 rounded-md flex items-center justify-center text-2xl">
                                üñ•Ô∏è
                            </div>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 truncate">
                                    Total VMs
                                </dt>
                                <dd class="text-2xl font-bold text-gray-900" x-text="stats.vms?.total || 0"></dd>
                                <dd class="text-xs text-gray-500" x-text="`${stats.vms?.running || 0} running`"></dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CPU Usage -->
            <div class="bg-white overflow-hidden shadow rounded-lg">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="w-12 h-12 bg-yellow-500 rounded-md flex items-center justify-center text-2xl">
                                ‚ö°
                            </div>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 truncate">
                                    CPU Usage
                                </dt>
                                <dd class="text-2xl font-bold text-gray-900" x-text="`${stats.host?.cpu_percent?.toFixed(1) || 0}%`"></dd>
                                <dd class="text-xs text-gray-500" x-text="`${stats.host?.cpu_count || 0} cores`"></dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Security Events -->
            <div class="bg-white overflow-hidden shadow rounded-lg">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="w-12 h-12 bg-red-500 rounded-md flex items-center justify-center text-2xl">
                                üö®
                            </div>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 truncate">
                                    Events (24h)
                                </dt>
                                <dd class="text-2xl font-bold text-gray-900" x-text="stats.events?.last_24h || 0"></dd>
                                <dd class="text-xs text-red-600" x-text="`${stats.events?.critical || 0} critical`"></dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Actions -->
        <div class="bg-white shadow rounded-lg p-6">
            <h2 class="text-lg font-medium text-gray-900 mb-4">Quick Actions</h2>
            <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3">
                <button @click="loadData()" class="inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    <span class="mr-2">üîÑ</span>
                    Refresh System Status
                </button>
                <button @click="emergencyStopAll()" class="inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-yellow-600 hover:bg-yellow-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-500">
                    <span class="mr-2">üõë</span>
                    Emergency Stop All VMs
                </button>
                <button @click="cleanupMetrics()" class="inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500">
                    <span class="mr-2">üóëÔ∏è</span>
                    Cleanup Old Metrics
                </button>
            </div>
        </div>

        <!-- User Management -->
        <div class="bg-white shadow rounded-lg p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-medium text-gray-900">User Management</h2>
                <div x-show="selectedUsers.length > 0" class="flex space-x-2">
                    <span class="text-sm text-gray-600 py-2" x-text="`${selectedUsers.length} selected`"></span>
                    <button @click="openBulkCreditModal()" class="text-sm px-3 py-1 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">
                        Bulk Credits
                    </button>
                    <button @click="bulkDeactivate()" class="text-sm px-3 py-1 bg-yellow-600 text-white rounded-md hover:bg-yellow-700">
                        Bulk Deactivate
                    </button>
                    <button @click="bulkActivate()" class="text-sm px-3 py-1 bg-green-600 text-white rounded-md hover:bg-green-700">
                        Bulk Activate
                    </button>
                    <button @click="selectedUsers = []" class="text-sm px-3 py-1 bg-gray-600 text-white rounded-md hover:bg-gray-700">
                        Clear Selection
                    </button>
                </div>
            </div>
            
            <template x-if="loading">
                <div class="text-center py-8 text-gray-500">
                    Loading users...
                </div>
            </template>
            
            <template x-if="!loading && users.length === 0">
                <div class="text-center py-8 text-gray-500">
                    No users registered yet
                </div>
            </template>
            
            <template x-if="!loading && users.length > 0">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    <input type="checkbox" @change="toggleSelectAll($event)" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Credits</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <template x-for="user in users" :key="user.id">
                                <tr :class="selectedUsers.includes(user.id) ? 'bg-indigo-50' : ''">
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <input type="checkbox" :value="user.id" @change="toggleUserSelection(user.id, $event)" :checked="selectedUsers.includes(user.id)" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-sm font-medium text-gray-900" x-text="user.username"></div>
                                        <div class="text-xs text-gray-500" x-text="`ID: ${user.id}`"></div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="user.email"></td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span :class="user.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'" class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full" x-text="user.is_active ? 'Active' : 'Inactive'">
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="user.credits"></td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span :class="user.is_admin ? 'bg-purple-100 text-purple-800' : 'bg-gray-100 text-gray-800'" class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full" x-text="user.is_admin ? 'Admin' : 'User'">
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                                        <button @click="openCreditModal(user)" class="text-indigo-600 hover:text-indigo-900">Credits</button>
                                        <button @click="toggleUserStatus(user)" class="text-yellow-600 hover:text-yellow-900" x-text="user.is_active ? 'Deactivate' : 'Activate'"></button>
                                        <button @click="deleteUser(user)" class="text-red-600 hover:text-red-900">Delete</button>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </template>
        </div>

        <!-- VM Management -->
        <div class="bg-white shadow rounded-lg p-6">
            <h2 class="text-lg font-medium text-gray-900 mb-4">VM Management</h2>
            
            <template x-if="loading">
                <div class="text-center py-8 text-gray-500">
                    Loading VMs...
                </div>
            </template>
            
            <template x-if="!loading && vms.length === 0">
                <div class="text-center py-8 text-gray-500">
                    No VMs deployed yet
                </div>
            </template>
            
            <template x-if="!loading && vms.length > 0">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">VM Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Owner</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Resources</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">IP</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <template x-for="vm in vms" :key="vm.id">
                                <tr>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-sm font-medium text-gray-900" x-text="vm.name"></div>
                                        <div class="text-xs text-gray-500" x-text="vm.os_type"></div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="vm.owner?.username || 'Unknown'"></td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span :class="{
                                            'bg-green-100 text-green-800': vm.status === 'running',
                                            'bg-red-100 text-red-800': vm.status === 'stopped',
                                            'bg-yellow-100 text-yellow-800': vm.status === 'pending',
                                            'bg-gray-100 text-gray-800': vm.status === 'error'
                                        }" class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full" x-text="vm.status">
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                        <div x-text="`${vm.ram_mb}MB RAM`"></div>
                                        <div x-text="`${vm.cpu_cores} CPU, ${vm.disk_gb}GB`"></div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="vm.ip_address || 'N/A'"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                                        <template x-if="vm.status === 'stopped'">
                                            <button @click="vmAction(vm.id, 'start')" class="text-green-600 hover:text-green-900">Start</button>
                                        </template>
                                        <template x-if="vm.status === 'running'">
                                            <button @click="vmAction(vm.id, 'stop')" class="text-yellow-600 hover:text-yellow-900">Stop</button>
                                        </template>
                                        <button @click="vmAction(vm.id, 'destroy')" class="text-red-600 hover:text-red-900">Destroy</button>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </template>
        </div>

        <!-- Security Operations Center (SOC) Feed -->
        <div class="bg-white shadow rounded-lg p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-medium text-gray-900">Security Events (SOC Feed)</h2>
                <div class="flex space-x-2">
                    <select x-model="socFilters.severity" @change="loadSOCEvents()" class="text-sm border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="">All Severities</option>
                        <option value="info">Info</option>
                        <option value="warning">Warning</option>
                        <option value="critical">Critical</option>
                    </select>
                    <select x-model="socFilters.type" @change="loadSOCEvents()" class="text-sm border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="">All Types</option>
                        <option value="vm">VM Events</option>
                        <option value="auth">Authentication</option>
                        <option value="admin">Admin Actions</option>
                        <option value="security">Security</option>
                        <option value="system">System</option>
                    </select>
                    <button @click="loadSOCEvents()" class="text-sm px-3 py-1 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">
                        üîÑ Refresh
                    </button>
                </div>
            </div>
            
            <template x-if="socLoading">
                <div class="text-center py-8 text-gray-500">
                    Loading security events...
                </div>
            </template>
            
            <template x-if="!socLoading && socEvents.length === 0">
                <div class="text-center py-8 text-gray-500">
                    No security events found
                </div>
            </template>
            
            <template x-if="!socLoading && socEvents.length > 0">
                <div class="space-y-2 max-h-96 overflow-y-auto">
                    <template x-for="event in socEvents" :key="event.id">
                        <div :class="{
                            'border-l-4 border-blue-500 bg-blue-50': event.severity === 'info',
                            'border-l-4 border-yellow-500 bg-yellow-50': event.severity === 'warning',
                            'border-l-4 border-red-500 bg-red-50': event.severity === 'critical'
                        }" class="p-3 rounded-r-md">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <div class="flex items-center space-x-2">
                                        <span :class="{
                                            'bg-blue-100 text-blue-800': event.severity === 'info',
                                            'bg-yellow-100 text-yellow-800': event.severity === 'warning',
                                            'bg-red-100 text-red-800': event.severity === 'critical'
                                        }" class="px-2 py-1 text-xs font-semibold rounded-full" x-text="event.severity.toUpperCase()"></span>
                                        <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded-full" x-text="event.type"></span>
                                        <span class="text-xs text-gray-400" x-text="new Date(event.created_at).toLocaleString()"></span>
                                    </div>
                                    <p class="text-sm text-gray-900 mt-1" x-text="event.message"></p>
                                    <div class="flex space-x-3 mt-1 text-xs text-gray-500">
                                        <span x-show="event.user" x-text="`User: ${event.user || event.user_id || 'N/A'}`"></span>
                                        <span x-show="event.vm_name" x-text="`VM: ${event.vm_name || event.vm_id || ''}`"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </template>
        </div>
    </div>

    <!-- Credit Adjustment Modal -->
    <div x-show="creditModal.show" class="fixed z-10 inset-0 overflow-y-auto" x-cloak>
        <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 transition-opacity" @click="creditModal.show = false">
                <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
            </div>

            <div class="inline-block align-bottom bg-white rounded-lg px-4 pt-5 pb-4 text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full sm:p-6">
                <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">
                    Adjust Credits for <span x-text="creditModal.user?.username"></span>
                </h3>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Current Credits</label>
                        <p class="text-2xl font-bold text-gray-900" x-text="creditModal.user?.credits"></p>
                    </div>
                    
                    <div>
                        <label for="credit-amount" class="block text-sm font-medium text-gray-700">Amount to Add/Subtract</label>
                        <input type="number" id="credit-amount" x-model.number="creditModal.amount" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="e.g., 100 or -50">
                    </div>
                    
                    <div>
                        <label for="credit-reason" class="block text-sm font-medium text-gray-700">Reason (optional)</label>
                        <input type="text" id="credit-reason" x-model="creditModal.reason" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="e.g., Bonus credits">
                    </div>
                </div>
                
                <div class="mt-5 sm:mt-6 sm:grid sm:grid-cols-2 sm:gap-3 sm:grid-flow-row-dense">
                    <button @click="adjustCredits()" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:col-start-2 sm:text-sm">
                        Adjust Credits
                    </button>
                    <button @click="creditModal.show = false" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:col-start-1 sm:text-sm">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Credit Adjustment Modal -->
    <div x-show="bulkCreditModal.show" class="fixed z-10 inset-0 overflow-y-auto" x-cloak>
        <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 transition-opacity" @click="bulkCreditModal.show = false">
                <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
            </div>

            <div class="inline-block align-bottom bg-white rounded-lg px-4 pt-5 pb-4 text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full sm:p-6">
                <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">
                    Bulk Credit Adjustment for <span x-text="selectedUsers.length"></span> Users
                </h3>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Selected Users</label>
                        <p class="text-sm text-gray-600" x-text="`Adjusting credits for ${selectedUsers.length} user(s)`"></p>
                    </div>
                    
                    <div>
                        <label for="bulk-credit-amount" class="block text-sm font-medium text-gray-700">Amount to Add/Subtract</label>
                        <input type="number" id="bulk-credit-amount" x-model.number="bulkCreditModal.amount" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="e.g., 100 or -50">
                    </div>
                    
                    <div>
                        <label for="bulk-credit-reason" class="block text-sm font-medium text-gray-700">Reason (optional)</label>
                        <input type="text" id="bulk-credit-reason" x-model="bulkCreditModal.reason" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="e.g., Bulk bonus credits">
                    </div>
                </div>
                
                <div class="mt-5 sm:mt-6 sm:grid sm:grid-cols-2 sm:gap-3 sm:grid-flow-row-dense">
                    <button @click="bulkAdjustCredits()" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:col-start-2 sm:text-sm">
                        Adjust Credits
                    </button>
                    <button @click="bulkCreditModal.show = false" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:col-start-1 sm:text-sm">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function adminPanel() {
    return {
        stats: {},
        users: [],
        vms: [],
        loading: true,
        selectedUsers: [],
        socEvents: [],
        socLoading: false,
        socFilters: {
            severity: '',
            type: '',
            hours: 24
        },
        creditModal: {
            show: false,
            user: null,
            amount: 0,
            reason: ''
        },
        bulkCreditModal: {
            show: false,
            amount: 0,
            reason: ''
        },
        
        async init() {
            await this.loadData();
            await this.loadSOCEvents();
            setInterval(() => this.loadData(), 30000);
            setInterval(() => this.loadSOCEvents(), 10000);
        },
        
        async loadData() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/login';
                return;
            }
            
            try {
                const [statsRes, usersRes, vmsRes] = await Promise.all([
                    fetch('/api/admin/statistics', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    }),
                    fetch('/api/admin/users', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    }),
                    fetch('/api/admin/vms', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    })
                ]);
                
                if (statsRes.status === 401 || usersRes.status === 401 || vmsRes.status === 401) {
                    localStorage.removeItem('token');
                    window.location.href = '/login';
                    return;
                }
                
                this.stats = await statsRes.json();
                this.users = await usersRes.json();
                this.vms = await vmsRes.json();
                this.loading = false;
            } catch (error) {
                console.error('Error loading admin data:', error);
                alert('Error loading admin data: ' + error.message);
            }
        },
        
        openCreditModal(user) {
            this.creditModal = {
                show: true,
                user: user,
                amount: 0,
                reason: ''
            };
        },
        
        async adjustCredits() {
            const token = localStorage.getItem('token');
            const { user, amount, reason } = this.creditModal;
            
            if (!amount || amount === 0) {
                alert('Please enter a non-zero amount');
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/users/${user.id}/credits`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ amount, reason })
                });
                
                if (response.ok) {
                    this.creditModal.show = false;
                    await this.loadData();
                    alert(`Credits adjusted successfully!`);
                } else {
                    const error = await response.json();
                    alert('Error: ' + error.detail);
                }
            } catch (error) {
                console.error('Error adjusting credits:', error);
                alert('Error adjusting credits: ' + error.message);
            }
        },
        
        async toggleUserStatus(user) {
            const token = localStorage.getItem('token');
            const newStatus = !user.is_active;
            
            if (!confirm(`Are you sure you want to ${newStatus ? 'activate' : 'deactivate'} user ${user.username}?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/users/${user.id}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ is_active: newStatus })
                });
                
                if (response.ok) {
                    await this.loadData();
                    alert(`User ${newStatus ? 'activated' : 'deactivated'} successfully!`);
                } else {
                    const error = await response.json();
                    alert('Error: ' + error.detail);
                }
            } catch (error) {
                console.error('Error updating user:', error);
                alert('Error updating user: ' + error.message);
            }
        },
        
        async deleteUser(user) {
            const token = localStorage.getItem('token');
            
            if (!confirm(`Are you sure you want to DELETE user ${user.username}? This will also destroy all their VMs. This action cannot be undone!`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/users/${user.id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    await this.loadData();
                    alert('User deleted successfully!');
                } else {
                    const error = await response.json();
                    alert('Error: ' + error.detail);
                }
            } catch (error) {
                console.error('Error deleting user:', error);
                alert('Error deleting user: ' + error.message);
            }
        },
        
        async vmAction(vmId, action) {
            const token = localStorage.getItem('token');
            
            if (action === 'destroy' && !confirm('Are you sure you want to destroy this VM? This action cannot be undone!')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/vms/${vmId}/action`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ action })
                });
                
                if (response.ok) {
                    await this.loadData();
                    alert(`VM ${action} successful!`);
                } else {
                    const error = await response.json();
                    alert('Error: ' + error.detail);
                }
            } catch (error) {
                console.error('Error performing VM action:', error);
                alert('Error performing VM action: ' + error.message);
            }
        },
        
        async emergencyStopAll() {
            const token = localStorage.getItem('token');
            
            if (!confirm('Are you sure you want to STOP ALL RUNNING VMs? This is an emergency action!')) {
                return;
            }
            
            try {
                const response = await fetch('/api/admin/emergency-stop-all', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    await this.loadData();
                    alert(`Emergency stop completed! Stopped: ${result.stopped}, Failed: ${result.failed}`);
                } else {
                    const error = await response.json();
                    alert('Error: ' + error.detail);
                }
            } catch (error) {
                console.error('Error performing emergency stop:', error);
                alert('Error performing emergency stop: ' + error.message);
            }
        },
        
        async cleanupMetrics() {
            const token = localStorage.getItem('token');
            const days = prompt('Delete metrics older than how many days?', '7');
            
            if (!days) return;
            
            try {
                const response = await fetch(`/api/metrics/cleanup?days=${days}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert(`Cleanup completed! Deleted ${result.deleted_count} old metrics.`);
                } else {
                    const error = await response.json();
                    alert('Error: ' + error.detail);
                }
            } catch (error) {
                console.error('Error cleaning up metrics:', error);
                alert('Error cleaning up metrics: ' + error.message);
            }
        },
        
        toggleUserSelection(userId, event) {
            if (event.target.checked) {
                if (!this.selectedUsers.includes(userId)) {
                    this.selectedUsers.push(userId);
                }
            } else {
                this.selectedUsers = this.selectedUsers.filter(id => id !== userId);
            }
        },
        
        toggleSelectAll(event) {
            if (event.target.checked) {
                this.selectedUsers = this.users.map(u => u.id);
            } else {
                this.selectedUsers = [];
            }
        },
        
        openBulkCreditModal() {
            if (this.selectedUsers.length === 0) {
                alert('Please select at least one user');
                return;
            }
            this.bulkCreditModal = {
                show: true,
                amount: 0,
                reason: ''
            };
        },
        
        async bulkAdjustCredits() {
            const token = localStorage.getItem('token');
            const { amount, reason } = this.bulkCreditModal;
            
            if (!amount || amount === 0) {
                alert('Please enter a non-zero amount');
                return;
            }
            
            if (!confirm(`Adjust credits by ${amount} for ${this.selectedUsers.length} user(s)?`)) {
                return;
            }
            
            try {
                let successCount = 0;
                let errorCount = 0;
                
                for (const userId of this.selectedUsers) {
                    const response = await fetch(`/api/admin/users/${userId}/credits`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ amount, reason: reason || 'Bulk credit adjustment' })
                    });
                    
                    if (response.ok) {
                        successCount++;
                    } else {
                        errorCount++;
                    }
                }
                
                this.bulkCreditModal.show = false;
                this.selectedUsers = [];
                await this.loadData();
                alert(`Bulk credit adjustment completed! Success: ${successCount}, Failed: ${errorCount}`);
            } catch (error) {
                console.error('Error adjusting bulk credits:', error);
                alert('Error adjusting bulk credits: ' + error.message);
            }
        },
        
        async bulkDeactivate() {
            if (this.selectedUsers.length === 0) {
                alert('Please select at least one user');
                return;
            }
            
            if (!confirm(`Deactivate ${this.selectedUsers.length} user(s)?`)) {
                return;
            }
            
            const token = localStorage.getItem('token');
            
            try {
                let successCount = 0;
                let errorCount = 0;
                
                for (const userId of this.selectedUsers) {
                    const response = await fetch(`/api/admin/users/${userId}`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ is_active: false })
                    });
                    
                    if (response.ok) {
                        successCount++;
                    } else {
                        errorCount++;
                    }
                }
                
                this.selectedUsers = [];
                await this.loadData();
                alert(`Bulk deactivation completed! Success: ${successCount}, Failed: ${errorCount}`);
            } catch (error) {
                console.error('Error deactivating users:', error);
                alert('Error deactivating users: ' + error.message);
            }
        },
        
        async bulkActivate() {
            if (this.selectedUsers.length === 0) {
                alert('Please select at least one user');
                return;
            }
            
            if (!confirm(`Activate ${this.selectedUsers.length} user(s)?`)) {
                return;
            }
            
            const token = localStorage.getItem('token');
            
            try {
                let successCount = 0;
                let errorCount = 0;
                
                for (const userId of this.selectedUsers) {
                    const response = await fetch(`/api/admin/users/${userId}`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ is_active: true })
                    });
                    
                    if (response.ok) {
                        successCount++;
                    } else {
                        errorCount++;
                    }
                }
                
                this.selectedUsers = [];
                await this.loadData();
                alert(`Bulk activation completed! Success: ${successCount}, Failed: ${errorCount}`);
            } catch (error) {
                console.error('Error activating users:', error);
                alert('Error activating users: ' + error.message);
            }
        },
        
        async loadSOCEvents() {
            const token = localStorage.getItem('token');
            if (!token) {
                return;
            }
            
            this.socLoading = true;
            
            try {
                const params = new URLSearchParams({
                    limit: '50',
                    hours: this.socFilters.hours.toString()
                });
                
                if (this.socFilters.severity) {
                    params.append('severity', this.socFilters.severity);
                }
                
                if (this.socFilters.type) {
                    params.append('event_type', this.socFilters.type);
                }
                
                const response = await fetch(`/api/admin/soc/all-events?${params}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.status === 401) {
                    localStorage.removeItem('token');
                    window.location.href = '/login';
                    return;
                }
                
                if (response.ok) {
                    this.socEvents = await response.json();
                }
            } catch (error) {
                console.error('Error loading SOC events:', error);
            } finally {
                this.socLoading = false;
            }
        }
    };
}
</script>

<style>
[x-cloak] {
    display: none !important;
}
</style>
{% endblock %}
